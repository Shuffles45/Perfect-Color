<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perfect Color Finder (Color Box)</title>
  <style>
    /* Reset & Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      text-align: center;
      background: white;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    h1 {
      margin-bottom: 20px;
    }
    #content p {
      margin-bottom: 15px;
      font-size: 1.1em;
    }
    .buttons-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    .color-button {
      width: 100px;
      height: 100px;
      border: none;
      border-radius: 50%;
      margin: 10px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .color-button:hover {
      transform: scale(1.1);
    }
    .final-color {
      width: 150px;
      height: 150px;
      margin: 20px auto;
      border-radius: 50%;
      border: 3px solid #333;
    }
    button#restart, button#back {
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background: #333;
      color: white;
      transition: background 0.2s;
      margin: 10px;
    }
    button#restart:hover, button#back:hover {
      background: #555;
    }
    /* Color box styling */
    #colorPickerContainer {
      margin-bottom: 15px;
    }
    #hueSlider {
      width: 300px;
      margin-bottom: 10px;
      -webkit-appearance: none;
      height: 15px;
      border-radius: 5px;
      background: linear-gradient(to right, 
        red, yellow, lime, cyan, blue, magenta, red);
    }
    #hueSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: #fff;
      border: 1px solid #333;
      cursor: pointer;
    }
    #colorBox {
      cursor: crosshair;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Find Your Perfect Color</h1>
    <div id="content"></div>
  </div>
  
  <script>
    /**********************
     * GLOBAL VARIABLES
     **********************/
    let currentCandidate = ""; // The current chosen HEX color.
    let zoomRoundIndex = 0;
    const numZoomRounds = 8;  // Total zoom rounds.
    const decayFactor = 1.5;  // How quickly the variation decreases.
    // History stack for back button functionality.
    const historyStack = [];
    
    const contentDiv = document.getElementById('content');
    
    // Canvas settings for the color box.
    const canvasSize = 300;
    
    /**********************
     * UTILITY FUNCTIONS
     **********************/
    function clamp(value, min, max) {
      return Math.min(Math.max(value, min), max);
    }
    
    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    function randomFloat(min, max) {
      return Math.random() * (max - min) + min;
    }
    
    function hexToRgb(hex) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return { r, g, b };
    }
    
    function rgbToHex({ r, g, b }) {
      const toHex = (c) => {
        const hex = c.toString(16);
        return hex.length === 1 ? '0' + hex : hex;
      };
      return '#' + toHex(r) + toHex(g) + toHex(b);
    }
    
    /**********************
     * HSV to RGB Conversion (for the color box)
     **********************/
    function hsvToRgb(h, s, v) {
      let c = v * s;
      let x = c * (1 - Math.abs(((h / 60) % 2) - 1));
      let m = v - c;
      let r, g, b;
      if (h < 60) { r = c; g = x; b = 0; }
      else if (h < 120) { r = x; g = c; b = 0; }
      else if (h < 180) { r = 0; g = c; b = x; }
      else if (h < 240) { r = 0; g = x; b = c; }
      else if (h < 300) { r = x; g = 0; b = c; }
      else { r = c; g = 0; b = x; }
      return { r: Math.round((r + m) * 255), g: Math.round((g + m) * 255), b: Math.round((b + m) * 255) };
    }
    
    /**********************
     * CIELAB CONVERSION FUNCTIONS
     **********************/
    function rgbToLab(rgb) {
      let r = rgb.r / 255, g = rgb.g / 255, b = rgb.b / 255;
      r = (r > 0.04045) ? Math.pow((r + 0.055) / 1.055, 2.4) : (r / 12.92);
      g = (g > 0.04045) ? Math.pow((g + 0.055) / 1.055, 2.4) : (g / 12.92);
      b = (b > 0.04045) ? Math.pow((b + 0.055) / 1.055, 2.4) : (b / 12.92);
      let X = r * 0.4124 + g * 0.3576 + b * 0.1805;
      let Y = r * 0.2126 + g * 0.7152 + b * 0.0722;
      let Z = r * 0.0193 + g * 0.1192 + b * 0.9505;
      X = X / 0.95047;
      Y = Y / 1.00000;
      Z = Z / 1.08883;
      function f(t) {
        return t > 0.008856 ? Math.pow(t, 1 / 3) : (7.787 * t + 16 / 116);
      }
      const fx = f(X), fy = f(Y), fz = f(Z);
      const L = (Y > 0.008856) ? (116 * fy - 16) : (903.3 * Y);
      const a = 500 * (fx - fy);
      const b_val = 200 * (fy - fz);
      return { L, a, b: b_val };
    }
    
    function labToRgb(lab) {
      let { L, a, b } = lab;
      let y = (L + 16) / 116;
      let x = a / 500 + y;
      let z = y - b / 200;
      function fInv(t) {
        return (t * t * t > 0.008856) ? t * t * t : ((t - 16 / 116) / 7.787);
      }
      let X = fInv(x) * 0.95047;
      let Y = fInv(y) * 1.00000;
      let Z = fInv(z) * 1.08883;
      let r = X * 3.2406 + Y * -1.5372 + Z * -0.4986;
      let g = X * -0.9689 + Y * 1.8758 + Z * 0.0415;
      let b_val = X * 0.0557 + Y * -0.2040 + Z * 1.0570;
      function gammaCorrect(c) {
        c = c <= 0.0031308 ? 12.92 * c : 1.055 * Math.pow(c, 1 / 2.4) - 0.055;
        return clamp(Math.round(c * 255), 0, 255);
      }
      return { r: gammaCorrect(r), g: gammaCorrect(g), b: gammaCorrect(b_val) };
    }
    
    /**********************
     * CANDIDATE GENERATION IN CIELAB SPACE
     **********************/
    function generateCandidateLab(currentLab, roundIndex) {
      const LDelta = Math.max(1, 15 / Math.pow(decayFactor, roundIndex));
      const aDelta = Math.max(1, 20 / Math.pow(decayFactor, roundIndex));
      const bDelta = Math.max(1, 20 / Math.pow(decayFactor, roundIndex));
      
      let newL = clamp(currentLab.L + randomFloat(-LDelta, LDelta), 0, 100);
      let newA = clamp(currentLab.a + randomFloat(-aDelta, aDelta), -128, 127);
      let newB = clamp(currentLab.b + randomFloat(-bDelta, bDelta), -128, 127);
      return { L: newL, a: newA, b: newB };
    }
    
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = randomInt(0, i);
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
    
    /**********************
     * STAGE 1: COLOR BOX SELECTION
     **********************/
    function displayColorBox() {
      contentDiv.innerHTML = `
        <p>Choose your starting color:</p>
        <div id="colorPickerContainer">
          <input type="range" id="hueSlider" min="0" max="360" value="0" />
          <br/>
          <canvas id="colorBox" width="${canvasSize}" height="${canvasSize}"></canvas>
        </div>
        <p>Click on the box to select a color (adjust saturation and brightness).</p>
      `;
    
      const hueSlider = document.getElementById('hueSlider');
      const colorBox = document.getElementById('colorBox');
    
      drawColorBox(colorBox, hueSlider.value);
    
      hueSlider.addEventListener('input', () => {
        drawColorBox(colorBox, hueSlider.value);
      });
    
      colorBox.addEventListener('click', (event) => {
        const rect = colorBox.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        const s = x / canvasSize;            // Saturation (0 to 1)
        const v = 1 - y / canvasSize;          // Value (1 to 0)
        const h = parseFloat(hueSlider.value);
        const rgb = hsvToRgb(h, s, v);
        currentCandidate = rgbToHex(rgb);
        zoomRoundIndex = 0;
        historyStack.length = 0; // Clear history.
        displayZoomRound();
      });
    }
    
    function drawColorBox(canvas, hue) {
      const ctx = canvas.getContext('2d');
      const imageData = ctx.createImageData(canvas.width, canvas.height);
      for (let y = 0; y < canvas.height; y++) {
        for (let x = 0; x < canvas.width; x++) {
          const s = x / canvas.width;
          const v = 1 - y / canvas.height;
          const { r, g, b } = hsvToRgb(hue, s, v);
          const index = (y * canvas.width + x) * 4;
          imageData.data[index] = r;
          imageData.data[index + 1] = g;
          imageData.data[index + 2] = b;
          imageData.data[index + 3] = 255;
        }
      }
      ctx.putImageData(imageData, 0, 0);
    }
    
    /**********************
     * STAGE 2: ZOOM ROUNDS (Using CIELAB)
     **********************/
    function displayZoomRound() {
      if (zoomRoundIndex >= numZoomRounds) {
        displayFinalZoom();
        return;
      }
      const currentRGB = hexToRgb(currentCandidate);
      const currentLab = rgbToLab(currentRGB);
      const candidate1Lab = generateCandidateLab(currentLab, zoomRoundIndex);
      const candidate2Lab = generateCandidateLab(currentLab, zoomRoundIndex);
      const candidate1Hex = rgbToHex(labToRgb(candidate1Lab));
      const candidate2Hex = rgbToHex(labToRgb(candidate2Lab));
    
      const options = [
        { hex: currentCandidate, label: "Keep Current" },
        { hex: candidate1Hex, label: "New Option" },
        { hex: candidate2Hex, label: "New Option" }
      ];
      shuffleArray(options);
    
      contentDiv.innerHTML = `<p>Zoom Round ${zoomRoundIndex + 1} of ${numZoomRounds}: Which option looks best?</p>`;
      const buttonsContainer = document.createElement('div');
      buttonsContainer.classList.add('buttons-container');
    
      options.forEach(option => {
        const btn = document.createElement('button');
        btn.classList.add('color-button');
        btn.style.backgroundColor = option.hex;
        btn.addEventListener('click', () => {
          historyStack.push({ candidate: currentCandidate, round: zoomRoundIndex });
          currentCandidate = option.hex;
          zoomRoundIndex++;
          displayZoomRound();
        });
        buttonsContainer.appendChild(btn);
      });
    
      contentDiv.appendChild(buttonsContainer);
    
      // Always display a Back button.
      const backButton = document.createElement('button');
      backButton.id = "back";
      backButton.textContent = "Back";
      backButton.addEventListener('click', () => {
        if (historyStack.length > 0) {
          const previousState = historyStack.pop();
          currentCandidate = previousState.candidate;
          zoomRoundIndex = previousState.round;
          displayZoomRound();
        } else {
          // If no history exists, return to the color box.
          displayColorBox();
        }
      });
      contentDiv.appendChild(backButton);
    }
    
    /**********************
     * STAGE 3: FINAL RESULT
     **********************/
    function displayFinalZoom() {
      contentDiv.innerHTML = `
        <p class="result">Your perfect color is:</p>
        <div class="final-color" style="background-color: ${currentCandidate};"></div>
        <p>Hex Code: ${currentCandidate}</p>
        <button id="restart">Try Again</button>
      `;
      document.getElementById('restart').addEventListener('click', resetAll);
    }
    
    /**********************
     * RESET FUNCTION
     **********************/
    function resetAll() {
      currentCandidate = "";
      zoomRoundIndex = 0;
      historyStack.length = 0;
      displayColorBox();
    }
    
    /**********************
     * INITIALIZE APP
     **********************/
    displayColorBox();
  </script>
</body>
</html>
